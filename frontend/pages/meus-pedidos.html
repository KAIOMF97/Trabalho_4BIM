<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Pedidos - AutoMax</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">AutoMax</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="/">Início</a></li>
                        <li><a href="/frontend/pages/carros.html">Carros</a></li>
                        <li><a href="/frontend/pages/sobre.html">Sobre</a></li>
                        <li><a href="/frontend/pages/contato.html">Contato</a></li>
                    </ul>
                </nav>
                <div class="user-info" id="user-info">
                    <!-- Conteúdo será preenchido pelo JavaScript -->
                </div>
                <a href="/frontend/pages/login.html" class="btn btn-primary" id="login-btn">Login</a>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title">Meus Pedidos</h1>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando seus pedidos...</p>
            </div>

            <div id="pedidos-container" class="hidden">
                <!-- Pedidos serão carregados aqui -->
            </div>

            <div id="error-message" class="alert alert-error hidden">
                Erro ao carregar os pedidos. Tente novamente mais tarde.
            </div>

            <div id="no-login" class="alert alert-info hidden">
                Você precisa fazer login para ver seus pedidos.
                <a href="/frontend/pages/login.html" class="btn btn-primary" style="margin-left: 1rem;">Fazer Login</a>
            </div>
        </div>
    </main>

    <footer style="background-color: #2c3e50; color: white; text-align: center; padding: 2rem 0; margin-top: 3rem;">
        <div class="container">
            <p>&copy; 2024 AutoMax. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const sessao = await Auth.verificarSessao();
            
            if (!sessao.logado) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('no-login').classList.remove('hidden');
                return;
            }

            await carregarPedidos(sessao.usuario.id);
        });

        async function carregarPedidos(usuarioId) {
            const loadingElement = document.getElementById('loading');
            const pedidosContainer = document.getElementById('pedidos-container');
            const errorMessage = document.getElementById('error-message');

            try {
                const pedidos = await API.buscarPedidosUsuario(usuarioId);

                if (pedidos && !pedidos.erro && Array.isArray(pedidos)) {
                    loadingElement.classList.add('hidden');
                    pedidosContainer.classList.remove('hidden');

                    if (pedidos.length === 0) {
                        pedidosContainer.innerHTML = `
                            <div style="text-align: center; padding: 3rem;">
                                <h3 style="color: #7f8c8d; margin-bottom: 1rem;">Você ainda não fez nenhum pedido</h3>
                                <p style="color: #95a5a6; margin-bottom: 2rem;">Que tal dar uma olhada em nossos carros disponíveis?</p>
                                <a href="/frontend/pages/carros.html" class="btn btn-primary">Ver Carros</a>
                            </div>
                        `;
                        return;
                    }

                    // Carregar detalhes dos itens para cada pedido
                    const pedidosComItens = await Promise.all(
                        pedidos.map(async (pedido) => {
                            try {
                                const itens = await API.buscarItensPedido(pedido.id);
                                return { ...pedido, itens: itens || [] };
                            } catch (error) {
                                console.error('Erro ao carregar itens do pedido:', error);
                                return { ...pedido, itens: [] };
                            }
                        })
                    );

                    pedidosContainer.innerHTML = pedidosComItens.map(pedido => `
                        <div class="card" style="margin-bottom: 2rem;">
                            <div class="card-content">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="color: #2c3e50; margin-bottom: 0.5rem;">Pedido #${pedido.id}</h3>
                                        <p style="color: #7f8c8d;">Data: ${new Date(pedido.data_pedido).toLocaleDateString('pt-BR')}</p>
                                    </div>
                                    <span class="badge ${getStatusClass(pedido.status)}">${getStatusText(pedido.status)}</span>
                                </div>

                                ${pedido.itens.length > 0 ? `
                                    <div style="border-top: 1px solid #ecf0f1; padding-top: 1rem;">
                                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">Itens do Pedido:</h4>
                                        ${pedido.itens.map(item => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f8f9fa;">
                                                <div>
                                                    <strong>${item.modelo}</strong> - ${item.marca} (${item.ano})
                                                    <br>
                                                    <small style="color: #7f8c8d;">Quantidade: ${item.quantidade}</small>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="color: #27ae60; font-weight: bold;">
                                                        R$ ${parseFloat(item.preco_unitario).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                                    </div>
                                                    <small style="color: #7f8c8d;">por unidade</small>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        <div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #ecf0f1;">
                                            <strong style="font-size: 1.2rem; color: #2c3e50;">
                                                Total: R$ ${calcularTotal(pedido.itens).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                            </strong>
                                        </div>
                                    </div>
                                ` : '<p style="color: #7f8c8d; font-style: italic;">Nenhum item encontrado para este pedido.</p>'}
                            </div>
                        </div>
                    `).join('');
                } else {
                    throw new Error('Erro ao carregar pedidos');
                }
            } catch (error) {
                console.error('Erro:', error);
                loadingElement.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'pendente': return 'status-pendente';
                case 'concluido': return 'status-concluido';
                case 'cancelado': return 'status-cancelado';
                default: return 'status-pendente';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pendente': return 'Pendente';
                case 'concluido': return 'Concluído';
                case 'cancelado': return 'Cancelado';
                default: return 'Pendente';
            }
        }

        function calcularTotal(itens) {
            return itens.reduce((total, item) => {
                return total + (parseFloat(item.preco_unitario) * parseInt(item.quantidade));
            }, 0);
        }
    </script>

    <style>
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-concluido {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-cancelado {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</body>
</html>

