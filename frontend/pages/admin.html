<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - AutoMax</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">AutoMax - Admin</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="/">In√≠cio</a></li>
                        <li><a href="/frontend/pages/carros.html">Carros</a></li>
                        <li><a href="/frontend/pages/admin.html">Painel Admin</a></li>
                    </ul>
                </nav>
                <div class="user-info" id="user-info">
                    <!-- Conte√∫do ser√° preenchido pelo JavaScript -->
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title">Painel de Controle</h1>

            <div id="access-denied" class="alert alert-error hidden">
                Acesso negado. Apenas administradores podem acessar esta p√°gina.
                <a href="/" class="btn btn-primary" style="margin-left: 1rem;">Voltar ao In√≠cio</a>
            </div>

            <div id="admin-content" class="hidden">
                <!-- Navega√ß√£o do painel -->
                <div style="background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" onclick="mostrarSecao('carros')">Gerenciar Carros</button>
                        <button class="btn btn-primary" onclick="mostrarSecao('acessorios')">Gerenciar Acess√≥rios</button>
                        <button class="btn btn-primary" onclick="mostrarSecao('pedidos')">Gerenciar Pedidos</button>
                        <button class="btn btn-primary" onclick="mostrarSecao('usuarios')">Gerenciar Usu√°rios</button>
                        <button class="btn btn-primary" onclick="mostrarSecao('relatorios')">Relat√≥rios</button>
                    </div>
                </div>

                <!-- Se√ß√£o de Carros -->
                <div id="secao-carros" class="admin-section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: #2c3e50;">Gerenciar Carros</h2>
                        <button class="btn btn-success" onclick="abrirModalCarro()">Adicionar Carro</button>
                    </div>
                    
                    <!-- Busca por ID para Carros -->
                    <section class="search-by-id" style="background:#f7f7f7; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <h3 style="margin-bottom:0.5rem; color: #2c3e50;">Buscar carro por ID</h3>
                        <input type="number" id="buscar-id-input-carros" placeholder="Digite o ID do carro" class="form-control" style="width:220px; display:inline-block; margin-right:0.5rem;">
                        <button class="btn btn-primary" onclick="buscarPorId('carros')">Buscar</button>
                        <div id="resultado-busca-carros" style="margin-top:1rem;"></div>
                    </section>
                    
                    <div id="carros-lista" class="table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Carregando carros...</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Acess√≥rios -->
                <div id="secao-acessorios" class="admin-section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: #2c3e50;">Gerenciar Acess√≥rios</h2>
                        <button class="btn btn-success" onclick="abrirModalAcessorio()">Adicionar Acess√≥rio</button>
                    </div>
                    
                    <!-- Busca por ID para Acess√≥rios -->
                    <section class="search-by-id" style="background:#f7f7f7; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <h3 style="margin-bottom:0.5rem; color: #2c3e50;">Buscar acess√≥rio por ID</h3>
                        <input type="number" id="buscar-id-input-acessorios" placeholder="Digite o ID do acess√≥rio" class="form-control" style="width:220px; display:inline-block; margin-right:0.5rem;">
                        <button class="btn btn-primary" onclick="buscarPorId('acessorios')">Buscar</button>
                        <div id="resultado-busca-acessorios" style="margin-top:1rem;"></div>
                    </section>
                    
                    <div id="acessorios-lista" class="table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Carregando acess√≥rios...</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Pedidos -->
                <div id="secao-pedidos" class="admin-section hidden">
                    <h2 style="color: #2c3e50; margin-bottom: 2rem;">Gerenciar Pedidos</h2>
                    
                    <!-- Busca por ID para Pedidos -->
                    <section class="search-by-id" style="background:#f7f7f7; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <h3 style="margin-bottom:0.5rem; color: #2c3e50;">Buscar pedido por ID</h3>
                        <input type="number" id="buscar-id-input-pedidos" placeholder="Digite o ID do pedido" class="form-control" style="width:220px; display:inline-block; margin-right:0.5rem;">
                        <button class="btn btn-primary" onclick="buscarPorId('pedidos')">Buscar</button>
                        <div id="resultado-busca-pedidos" style="margin-top:1rem;"></div>
                    </section>
                    
                    <div id="pedidos-lista" class="table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Carregando pedidos...</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Usu√°rios -->
                <div id="secao-usuarios" class="admin-section hidden">
                    <h2 style="color: #2c3e50; margin-bottom: 2rem;">Gerenciar Usu√°rios</h2>
                    
                    <!-- Busca por ID para Usu√°rios -->
                    <section class="search-by-id" style="background:#f7f7f7; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                        <h3 style="margin-bottom:0.5rem; color: #2c3e50;">Buscar usu√°rio por ID</h3>
                        <input type="number" id="buscar-id-input-usuarios" placeholder="Digite o ID do usu√°rio" class="form-control" style="width:220px; display:inline-block; margin-right:0.5rem;">
                        <button class="btn btn-primary" onclick="buscarPorId('usuarios')">Buscar</button>
                        <div id="resultado-busca-usuarios" style="margin-top:1rem;"></div>
                    </section>
                    
                    <div id="usuarios-lista" class="table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Carregando usu√°rios...</p>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Relat√≥rios -->
                <div id="secao-relatorios" class="admin-section hidden">
                    <h2 style="color: #2c3e50; margin-bottom: 2rem;">Relat√≥rios de Vendas</h2>
                    
                    <!-- Filtro e Bot√£o de Impress√£o -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center;">
                        <label for="filtro-mes">M√™s:</label>
                        <select id="filtro-mes" class="form-control" style="width: 150px;" onchange="carregarRelatorios()">
                            <option value="">Todos</option>
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>

                        <label for="filtro-ano">Ano:</label>
                        <select id="filtro-ano" class="form-control" style="width: 150px;" onchange="carregarRelatorios()">
                            <option value="">Todos</option>
                            <!-- Anos ser√£o preenchidos via JavaScript -->
                        </select>

                        <button class="btn btn-secondary" onclick="imprimirRelatorios()">Imprimir Relat√≥rios</button>
                    </div>

                    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <!-- Relat√≥rio de Vendas por Marca -->
                        <div style="flex: 1; min-width: 300px;">
                            <h3 style="margin-bottom: 1rem;">Vendas por Marca</h3>
                            <div id="relatorio-vendas-marca" class="table-container">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Carregando relat√≥rio de vendas por marca...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Relat√≥rio Top 5 Carros -->
                        <div style="flex: 1; min-width: 300px;">
                            <h3 style="margin-bottom: 1rem;">Top 5 Carros Mais Vendidos</h3>
                            <div id="relatorio-top-5-carros" class="table-container">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Carregando relat√≥rio de Top 5 carros...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Carro -->
    <div id="modal-carro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-carro-titulo">Adicionar Carro</h3>
                <span class="close" onclick="fecharModal('modal-carro')">&times;</span>
            </div>
            <form id="form-carro">
                <input type="hidden" id="carro-id">
                <div class="form-group">
                    <label for="carro-modelo">Modelo:</label>
                    <input type="text" id="carro-modelo" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="carro-marca">Marca:</label>
                    <input type="text" id="carro-marca" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="carro-ano">Ano:</label>
                    <input type="number" id="carro-ano" class="form-control" min="1990" max="2024" required>
                </div>
                <div class="form-group">
                    <label for="carro-preco">Pre√ßo:</label>
                    <input type="number" id="carro-preco" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="carro-descricao">Descri√ß√£o:</label>
                    <textarea id="carro-descricao" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="carro-imagem">Imagem do Carro:</label>
                    <input type="file" id="carro-imagem" class="form-control" accept="image/*">
                    <small class="form-text">Formatos aceitos: JPG, PNG, GIF, WebP (m√°ximo 5MB)</small>
                    <div id="preview-imagem" style="margin-top: 10px;"></div>
                </div>
                <div class="form-group">
                    <label>Acess√≥rios:</label>
                    <div id="acessorios-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 5px;">
                        <div class="loading" id="loading-acessorios">
                            <div class="spinner"></div>
                            <p>Carregando acess√≥rios...</p>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-carro')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Acess√≥rio -->
    <div id="modal-acessorio" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-acessorio-titulo">Adicionar Acess√≥rio</h3>
                <span class="close" onclick="fecharModal('modal-acessorio')">&times;</span>
            </div>
            <form id="form-acessorio">
                <input type="hidden" id="acessorio-id">
                <div class="form-group">
                    <label for="acessorio-nome">Nome:</label>
                    <input type="text" id="acessorio-nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="acessorio-descricao">Descri√ß√£o:</label>
                    <textarea id="acessorio-descricao" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="acessorio-preco">Pre√ßo:</label>
                    <input type="number" id="acessorio-preco" class="form-control" step="0.01" min="0" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-acessorio')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Usu√°rio -->
    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Usu√°rio</h3>
                <span class="close" onclick="fecharModal('modal-usuario')">&times;</span>
            </div>
            <form id="form-usuario">
                <input type="hidden" id="usuario-id">
                <div class="form-group">
                    <label for="usuario-nome">Nome Completo:</label>
                    <input type="text" id="usuario-nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="usuario-email">Email:</label>
                    <input type="email" id="usuario-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="usuario-tipo">Tipo de Usu√°rio:</label>
                    <select id="usuario-tipo" class="form-control" required>
                        <option value="cliente">Cliente</option>
                        <option value="admin">Administrador</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 0.5rem;">
                        ‚ö†Ô∏è Cuidado ao alterar para "Administrador" - isso dar√° acesso total ao sistema!
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-usuario')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <footer style="background-color: #2c3e50; color: white; text-align: center; padding: 2rem 0; margin-top: 3rem;">
        <div class="container">
            <p>&copy; 2024 AutoMax. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let secaoAtual = '';

        document.addEventListener('DOMContentLoaded', async () => {
            const sessao = await Auth.verificarSessao();
            
            if (!sessao.logado || sessao.usuario.tipo !== 'admin') {
                document.getElementById('access-denied').classList.remove('hidden');
                return;
            }

            document.getElementById('admin-content').classList.remove('hidden');
            
            // Preencher anos no select
            preencherAnosRelatorio();
            
            // Mostrar se√ß√£o de carros por padr√£o
            mostrarSecao('carros');
        });

        // Fun√ß√£o para preencher os anos no select de relat√≥rios
        function preencherAnosRelatorio() {
            const selectAno = document.getElementById('filtro-ano');
            const anoAtual = new Date().getFullYear();
            const anoInicio = 2020; // Ano inicial para o filtro
            
            // Adicionar anos do mais recente ao mais antigo
            for (let ano = anoAtual; ano >= anoInicio; ano--) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            }
        }

        // Fun√ß√£o para mostrar a se√ß√£o
        function mostrarSecao(secao) {
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            document.getElementById(`secao-${secao}`).classList.remove('hidden');

            // Carregar dados da se√ß√£o
            switch (secao) {
                case 'carros':
                    carregarCarros();
                    break;
                case 'acessorios':
                    carregarAcessorios();
                    break;
                case 'pedidos':
                    carregarPedidos();
                    break;
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'relatorios':
                    carregarRelatorios();
                    break;
            }
        }

        // Fun√ß√µes de carregamento de dados
        async function carregarCarros() {
            const container = document.getElementById('carros-lista');
            
            try {
                const carros = await API.listarCarros();
                
                if (carros && !carros.erro && Array.isArray(carros)) {
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Modelo</th>
                                    <th>Marca</th>
                                    <th>Ano</th>
                                    <th>Pre√ßo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${carros.map(carro => `
                                    <tr>
                                        <td>${carro.id}</td>
                                        <td>${carro.modelo}</td>
                                        <td>${carro.marca}</td>
                                        <td>${carro.ano}</td>
                                        <td>R$ ${parseFloat(carro.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="editarCarro(${carro.id})">Editar</button>
                                            <button class="btn btn-danger" onclick="deletarCarro(${carro.id})">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>Erro ao carregar carros.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar carros:', error);
                container.innerHTML = '<p>Erro ao carregar carros.</p>';
            }
        }

        async function carregarAcessorios() {
            const container = document.getElementById('acessorios-lista');
            
            try {
                const acessorios = await API.listarAcessorios();
                
                if (acessorios && !acessorios.erro && Array.isArray(acessorios)) {
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Pre√ßo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acessorios.map(acessorio => `
                                    <tr>
                                        <td>${acessorio.id}</td>
                                        <td>${acessorio.nome}</td>
                                        <td>${acessorio.descricao || 'N/A'}</td>
                                        <td>R$ ${parseFloat(acessorio.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="editarAcessorio(${acessorio.id})">Editar</button>
                                            <button class="btn btn-danger" onclick="deletarAcessorio(${acessorio.id})">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>Erro ao carregar acess√≥rios.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar acess√≥rios:', error);
                container.innerHTML = '<p>Erro ao carregar acess√≥rios.</p>';
            }
        }

        async function carregarPedidos() {
            const container = document.getElementById('pedidos-lista');
            
            try {
                const pedidos = await API.listarPedidos();
                
                if (pedidos && !pedidos.erro && Array.isArray(pedidos)) {
                    if (pedidos.length === 0) {
                        container.innerHTML = '<p style="text-align:center; padding:2rem; color:#666;">Nenhum pedido encontrado.</p>';
                        return;
                    }

                    container.innerHTML = `
                        <div style="display: grid; gap: 1.5rem;">
                            ${pedidos.map(pedido => {
                                const statusColors = {
                                    'pendente': '#ffc107',
                                    'concluido': '#28a745',
                                    'cancelado': '#dc3545'
                                };
                                const statusColor = statusColors[pedido.status] || '#6c757d';
                                
                                return `
                                    <div style="background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid ${statusColor};">
                                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: start;">
                                            <!-- Coluna 1: Informa√ß√µes Principais -->
                                            <div>
                                                <div style="background: ${statusColor}; color: white; padding: 0.5rem 1rem; border-radius: 5px; font-weight: bold; text-align: center; margin-bottom: 0.5rem;">
                                                    Pedido #${pedido.id}
                                                </div>
                                                <div style="font-size: 0.9rem; color: #666;">
                                                    <strong>Data:</strong><br>
                                                    ${new Date(pedido.data_pedido).toLocaleDateString('pt-BR', { 
                                                        day: '2-digit', 
                                                        month: '2-digit', 
                                                        year: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}
                                                </div>
                                            </div>

                                            <!-- Coluna 2: Detalhes do Pedido -->
                                            <div style="display: grid; gap: 0.5rem;">
                                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                                    <!-- Cliente -->
                                                    <div>
                                                        <strong style="color: #2c3e50;">üë§ Cliente:</strong><br>
                                                        <span style="color: #555;">${pedido.usuario_nome || 'N/A'}</span><br>
                                                        <small style="color: #888;">${pedido.usuario_email || ''}</small>
                                                    </div>

                                                    <!-- Carro -->
                                                    ${pedido.carro_modelo ? `
                                                        <div>
                                                            <strong style="color: #2c3e50;">üöó Ve√≠culo:</strong><br>
                                                            <span style="color: #555;">${pedido.carro_modelo}</span><br>
                                                            <small style="color: #888;">${pedido.carro_marca} - ${pedido.carro_ano || ''}</small>
                                                        </div>
                                                    ` : ''}

                                                    <!-- Valor -->
                                                    ${pedido.valor_total ? `
                                                        <div>
                                                            <strong style="color: #2c3e50;">üí∞ Valor Total:</strong><br>
                                                            <span style="color: #27ae60; font-size: 1.2rem; font-weight: bold;">
                                                                R$ ${parseFloat(pedido.valor_total).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                                            </span>
                                                        </div>
                                                    ` : ''}
                                                </div>

                                                <!-- Informa√ß√µes Adicionais -->
                                                ${pedido.metodo_pagamento || pedido.parcelas || pedido.endereco_cidade ? `
                                                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                                                            ${pedido.metodo_pagamento ? `
                                                                <div>
                                                                    <strong style="color: #666;">üí≥ Pagamento:</strong>
                                                                    <span style="color: #555;">
                                                                        ${pedido.metodo_pagamento === 'credit' ? 'Cart√£o de Cr√©dito' : 
                                                                          pedido.metodo_pagamento === 'debit' ? 'Cart√£o de D√©bito' : 
                                                                          pedido.metodo_pagamento === 'financing' ? 'Financiamento' : pedido.metodo_pagamento}
                                                                    </span>
                                                                </div>
                                                            ` : ''}
                                                            
                                                            ${pedido.parcelas ? `
                                                                <div>
                                                                    <strong style="color: #666;">üìä Parcelamento:</strong>
                                                                    <span style="color: #555;">${pedido.parcelas}x de R$ ${parseFloat(pedido.valor_parcela || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                                                </div>
                                                            ` : ''}
                                                            
                                                            ${pedido.endereco_cidade ? `
                                                                <div>
                                                                    <strong style="color: #666;">üìç Cidade:</strong>
                                                                    <span style="color: #555;">${pedido.endereco_cidade} - ${pedido.endereco_estado || ''}</span>
                                                                </div>
                                                            ` : ''}

                                                            ${pedido.cpf ? `
                                                                <div>
                                                                    <strong style="color: #666;">üÜî CPF:</strong>
                                                                    <span style="color: #555;">${pedido.cpf}</span>
                                                                </div>
                                                            ` : ''}

                                                            ${pedido.telefone ? `
                                                                <div>
                                                                    <strong style="color: #666;">üìû Telefone:</strong>
                                                                    <span style="color: #555;">${pedido.telefone}</span>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                            </div>

                                            <!-- Coluna 3: A√ß√µes -->
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 120px;">
                                                <button class="btn btn-secondary" onclick="editarPedido(${pedido.id})" style="width: 100%;">
                                                    ‚úèÔ∏è Editar Status
                                                </button>
                                                <button class="btn btn-danger" onclick="deletarPedido(${pedido.id})" style="width: 100%;">
                                                    üóëÔ∏è Excluir
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="text-align:center; padding:2rem; color:#dc3545;">Erro ao carregar pedidos.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                container.innerHTML = '<p style="text-align:center; padding:2rem; color:#dc3545;">Erro ao carregar pedidos.</p>';
            }
        }

        async function carregarUsuarios() {
            const container = document.getElementById('usuarios-lista');
            
            try {
                const usuarios = await API.listarUsuarios();
                
                if (usuarios && !usuarios.erro && Array.isArray(usuarios)) {
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usuarios.map(usuario => `
                                    <tr>
                                        <td>${usuario.id}</td>
                                        <td>${usuario.nome}</td>
                                        <td>${usuario.email}</td>
                                        <td>${usuario.tipo}</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="editarUsuario(${usuario.id})">Editar</button>
                                            <button class="btn btn-danger" onclick="deletarUsuario(${usuario.id})">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>Erro ao carregar usu√°rios.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                container.innerHTML = '<p>Erro ao carregar usu√°rios.</p>';
            }
        }

        // Fun√ß√£o de busca din√¢mica por ID
        async function buscarPorId(tipo) {
            const id = document.getElementById(`buscar-id-input-${tipo}`).value;
            const resultadoContainer = document.getElementById(`resultado-busca-${tipo}`);
            
            if (!id) {
                alert('Digite um ID v√°lido');
                return;
            }

            try {
                let resultado;
                let htmlResultado = '';

                switch (tipo) {
                    case 'carros':
                        resultado = await API.buscarCarro(id);
                        if (resultado.erro) {
                            resultadoContainer.innerHTML = '<p>Nenhum carro encontrado com esse ID.</p>';
                            return;
                        }
                        const img = resultado.imagem_url ? ('/uploads/carros/' + resultado.imagem_url) : '/frontend/img/no-image.png';
                        htmlResultado = `
                            <div class="item-busca" style="border:1px solid #ddd; padding:1rem; border-radius:6px;">
                                <h4>${resultado.marca} ${resultado.modelo} (${resultado.ano}) - R$ ${parseFloat(resultado.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h4>
                                <p>${resultado.descricao || ''}</p>
                                <img src="${img}" alt="Imagem" style="max-width:200px; display:block; margin-top:0.5rem;">
                                <div style="margin-top:1rem;">
                                    <button class="btn btn-secondary" onclick="editarCarro(${resultado.id})">Editar</button>
                                    <button class="btn btn-danger" onclick="deletarCarro(${resultado.id})">Excluir</button>
                                </div>
                            </div>`;
                        break;

                    case 'acessorios':
                        resultado = await API.buscarAcessorio(id);
                        if (resultado.erro) {
                            resultadoContainer.innerHTML = '<p>Nenhum acess√≥rio encontrado com esse ID.</p>';
                            return;
                        }
                        htmlResultado = `
                            <div class="item-busca" style="border:1px solid #ddd; padding:1rem; border-radius:6px;">
                                <h4>${resultado.nome} - R$ ${parseFloat(resultado.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</h4>
                                <p>${resultado.descricao || 'Sem descri√ß√£o'}</p>
                                <div style="margin-top:1rem;">
                                    <button class="btn btn-secondary" onclick="editarAcessorio(${resultado.id})">Editar</button>
                                    <button class="btn btn-danger" onclick="deletarAcessorio(${resultado.id})">Excluir</button>
                                </div>
                            </div>`;
                        break;

                    case 'pedidos':
                        resultado = await API.buscarPedido(id);
                        if (resultado.erro) {
                            resultadoContainer.innerHTML = '<p>Nenhum pedido encontrado com esse ID.</p>';
                            return;
                        }
                        htmlResultado = `
                            <div class="item-busca" style="border:1px solid #ddd; padding:1rem; border-radius:6px;">
                                <h4>Pedido #${resultado.id}</h4>
                                <p><strong>Cliente:</strong> ${resultado.usuario_nome || 'N/A'}</p>
                                <p><strong>Data:</strong> ${new Date(resultado.data_pedido).toLocaleDateString('pt-BR')}</p>
                                <p><strong>Status:</strong> ${resultado.status}</p>
                                <div style="margin-top:1rem;">
                                    <button class="btn btn-secondary" onclick="editarPedido(${resultado.id})">Editar</button>
                                    <button class="btn btn-danger" onclick="deletarPedido(${resultado.id})">Excluir</button>
                                </div>
                            </div>`;
                        break;

                    case 'usuarios':
                        resultado = await API.buscarUsuario(id);
                        if (resultado.erro) {
                            resultadoContainer.innerHTML = '<p>Nenhum usu√°rio encontrado com esse ID.</p>';
                            return;
                        }
                        htmlResultado = `
                            <div class="item-busca" style="border:1px solid #ddd; padding:1rem; border-radius:6px;">
                                <h4>${resultado.nome}</h4>
                                <p><strong>Email:</strong> ${resultado.email}</p>
                                <p><strong>Tipo:</strong> ${resultado.tipo}</p>
                                <div style="margin-top:1rem;">
                                    <button class="btn btn-secondary" onclick="editarUsuario(${resultado.id})">Editar</button>
                                    <button class="btn btn-danger" onclick="deletarUsuario(${resultado.id})">Excluir</button>
                                </div>
                            </div>`;
                        break;
                }

                resultadoContainer.innerHTML = htmlResultado;
            } catch (error) {
                console.error(`Erro ao buscar ${tipo}:`, error);
                alert(`Erro ao buscar ${tipo}`);
            }
        }

        // Fun√ß√µes de edi√ß√£o e exclus√£o para carros
        async function editarCarro(id) {
            try {
                const carro = await API.buscarCarro(id);
                if (carro.erro) {
                    alert('Erro ao carregar dados do carro');
                    return;
                }

                document.getElementById('carro-id').value = carro.id;
                document.getElementById('carro-modelo').value = carro.modelo;
                document.getElementById('carro-marca').value = carro.marca;
                document.getElementById('carro-ano').value = carro.ano;
                document.getElementById('carro-preco').value = carro.preco;
                document.getElementById('carro-descricao').value = carro.descricao || '';
                document.getElementById('modal-carro-titulo').textContent = 'Editar Carro';
                document.getElementById('modal-carro').style.display = 'block';
            } catch (error) {
                console.error('Erro ao editar carro:', error);
                alert('Erro ao carregar dados do carro');
            }
        }

        async function deletarCarro(id) {
            if (!confirm('Tem certeza que deseja excluir este carro?')) return;

            try {
                const resultado = await API.deletarCarro(id);
                if (resultado.sucesso) {
                    alert('Carro exclu√≠do com sucesso!');
                    carregarCarros();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-carros').innerHTML = '';
                } else {
                    alert('Erro ao excluir carro: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao excluir carro:', error);
                alert('Erro ao excluir carro.');
            }
        }

        // Fun√ß√µes de edi√ß√£o e exclus√£o para acess√≥rios
        async function editarAcessorio(id) {
            try {
                const acessorio = await API.buscarAcessorio(id);
                if (acessorio.erro) {
                    alert('Erro ao carregar dados do acess√≥rio');
                    return;
                }

                document.getElementById('acessorio-id').value = acessorio.id;
                document.getElementById('acessorio-nome').value = acessorio.nome;
                document.getElementById('acessorio-descricao').value = acessorio.descricao || '';
                document.getElementById('acessorio-preco').value = acessorio.preco;
                document.getElementById('modal-acessorio-titulo').textContent = 'Editar Acess√≥rio';
                document.getElementById('modal-acessorio').style.display = 'block';
            } catch (error) {
                console.error('Erro ao editar acess√≥rio:', error);
                alert('Erro ao carregar dados do acess√≥rio');
            }
        }

        async function deletarAcessorio(id) {
            if (!confirm('Tem certeza que deseja excluir este acess√≥rio?')) return;

            try {
                const resultado = await API.deletarAcessorio(id);
                if (resultado.sucesso) {
                    alert('Acess√≥rio exclu√≠do com sucesso!');
                    carregarAcessorios();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-acessorios').innerHTML = '';
                } else {
                    alert('Erro ao excluir acess√≥rio: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao excluir acess√≥rio:', error);
                alert('Erro ao excluir acess√≥rio.');
            }
        }

        // Fun√ß√µes de edi√ß√£o e exclus√£o para pedidos
        async function editarPedido(id) {
            const novoStatus = prompt('Digite o novo status do pedido:', 'pendente');
            if (!novoStatus) return;

            try {
                const resultado = await API.atualizarPedido(id, novoStatus);
                if (resultado.sucesso) {
                    alert('Pedido atualizado com sucesso!');
                    carregarPedidos();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-pedidos').innerHTML = '';
                } else {
                    alert('Erro ao atualizar pedido: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao atualizar pedido:', error);
                alert('Erro ao atualizar pedido.');
            }
        }

        async function deletarPedido(id) {
            if (!confirm('Tem certeza que deseja excluir este pedido?')) return;

            try {
                const resultado = await API.deletarPedido(id);
                if (resultado.sucesso) {
                    alert('Pedido exclu√≠do com sucesso!');
                    carregarPedidos();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-pedidos').innerHTML = '';
                } else {
                    alert('Erro ao excluir pedido: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                alert('Erro ao excluir pedido.');
            }
        }

        // Fun√ß√µes de Relat√≥rios
        async function carregarRelatorios() {
            // Obter valores dos filtros
            const mes = document.getElementById('filtro-mes').value;
            const ano = document.getElementById('filtro-ano').value;
            
            // Construir query params
            const params = new URLSearchParams();
            if (mes) params.append('mes', mes);
            if (ano) params.append('ano', ano);
            
            // Vendas por Marca
            const resMarca = await API.getVendasPorMarca(params.toString());
            const containerMarca = document.getElementById('relatorio-vendas-marca');
            containerMarca.innerHTML = '';
            if (resMarca.sucesso && resMarca.relatorio.length > 0) {
                containerMarca.innerHTML = criarTabelaRelatorio(resMarca.relatorio, ['Marca', 'Total Vendido']);
            } else {
                containerMarca.innerHTML = '<p>Nenhum dado de vendas por marca encontrado.</p>';
            }

            // Top 5 Carros
            const resTop5 = await API.getTop5CarrosMaisVendidos(params.toString());
            const containerTop5 = document.getElementById('relatorio-top-5-carros');
            containerTop5.innerHTML = '';
            if (resTop5.sucesso && resTop5.relatorio.length > 0) {
                containerTop5.innerHTML = criarTabelaRelatorio(resTop5.relatorio, ['Modelo', 'Marca', 'Ano', 'Total Vendido']);
            } else {
                containerTop5.innerHTML = '<p>Nenhum dado de Top 5 carros encontrado.</p>';
            }
        }

        function criarTabelaRelatorio(dados, colunas) {
            let html = '<table class="data-table">';
            html += '<thead><tr>';
            colunas.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';

            dados.forEach(item => {
                html += '<tr>';
                Object.values(item).forEach(valor => {
                    html += `<td>${valor}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Fun√ß√£o para imprimir relat√≥rios
        function imprimirRelatorios() {
            window.print();
        }

        // Fun√ß√µes de edi√ß√£o e exclus√£o para usu√°rios
        async function editarUsuario(id) {
            try {
                const usuario = await API.buscarUsuario(id);
                if (usuario.erro) {
                    alert('Erro ao carregar dados do usu√°rio');
                    return;
                }

                // Preencher o formul√°rio com os dados do usu√°rio
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-nome').value = usuario.nome;
                document.getElementById('usuario-email').value = usuario.email;
                document.getElementById('usuario-tipo').value = usuario.tipo;

                // Abrir o modal
                document.getElementById('modal-usuario').style.display = 'block';
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                alert('Erro ao carregar dados do usu√°rio.');
            }
        }

        async function deletarUsuario(id) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio?')) return;

            try {
                const resultado = await API.deletarUsuario(id);
                if (resultado.sucesso) {
                    alert('Usu√°rio exclu√≠do com sucesso!');
                    carregarUsuarios();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-usuarios').innerHTML = '';
                } else {
                    alert('Erro ao excluir usu√°rio: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                alert('Erro ao excluir usu√°rio.');
            }
        }

        // Fun√ß√µes para modais
        async function abrirModalCarro() {
            document.getElementById('form-carro').reset();
            document.getElementById('carro-id').value = '';
            document.getElementById('modal-carro-titulo').textContent = 'Adicionar Carro';
            document.getElementById('modal-carro').style.display = 'block';
            await carregarAcessoriosParaCarro();
        }

        function abrirModalAcessorio() {
            document.getElementById('form-acessorio').reset();
            document.getElementById('acessorio-id').value = '';
            document.getElementById('modal-acessorio-titulo').textContent = 'Adicionar Acess√≥rio';
            document.getElementById('modal-acessorio').style.display = 'block';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Fun√ß√£o para carregar acess√≥rios no modal de carro
        async function carregarAcessoriosParaCarro() {
            const container = document.getElementById('acessorios-container');
            
            try {
                const acessorios = await API.listarAcessorios();
                
                if (acessorios && Array.isArray(acessorios)) {
                    container.innerHTML = acessorios.map(acessorio => `
                        <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 5px;">
                            <input type="checkbox" id="acessorio-${acessorio.id}" value="${acessorio.id}" style="margin-right: 10px;">
                            <label for="acessorio-${acessorio.id}" style="flex: 1; margin-right: 10px;">
                                <strong>${acessorio.nome}</strong> - R$ ${parseFloat(acessorio.preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                <br><small style="color: #666;">${acessorio.descricao || 'Sem descri√ß√£o'}</small>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <label for="quantidade-${acessorio.id}" style="margin-right: 5px;">Qtd:</label>
                                <input type="number" id="quantidade-${acessorio.id}" min="1" value="1" style="width: 60px; padding: 2px;" disabled>
                            </div>
                        </div>
                    `).join('');
                    
                    // Adicionar event listeners para habilitar/desabilitar campos de quantidade
                    acessorios.forEach(acessorio => {
                        const checkbox = document.getElementById(`acessorio-${acessorio.id}`);
                        const quantidadeInput = document.getElementById(`quantidade-${acessorio.id}`);
                        
                        checkbox.addEventListener('change', function() {
                            quantidadeInput.disabled = !this.checked;
                            if (!this.checked) {
                                quantidadeInput.value = 1;
                            }
                        });
                    });
                } else {
                    container.innerHTML = '<p>Nenhum acess√≥rio dispon√≠vel.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar acess√≥rios:', error);
                container.innerHTML = '<p>Erro ao carregar acess√≥rios.</p>';
            }
        }

        // Eventos de formul√°rio
        document.getElementById('form-carro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const id = document.getElementById('carro-id').value;
            
            formData.append('modelo', document.getElementById('carro-modelo').value);
            formData.append('marca', document.getElementById('carro-marca').value);
            formData.append('ano', document.getElementById('carro-ano').value);
            formData.append('preco', document.getElementById('carro-preco').value);
            formData.append('descricao', document.getElementById('carro-descricao').value);
            
            // Coletar acess√≥rios selecionados
            const acessoriosSelecionados = [];
            const checkboxes = document.querySelectorAll('#acessorios-container input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                const acessorioId = checkbox.value;
                const quantidade = document.getElementById(`quantidade-${acessorioId}`).value;
                acessoriosSelecionados.push({
                    acessorio_id: parseInt(acessorioId),
                    quantidade: parseInt(quantidade)
                });
            });
            
            if (acessoriosSelecionados.length > 0) {
                formData.append('acessorios', JSON.stringify(acessoriosSelecionados));
            }
            
            const imagemFile = document.getElementById('carro-imagem').files[0];
            if (imagemFile) {
                formData.append('imagem', imagemFile);
            }

            try {
                let resultado;
                if (id) {
                    resultado = await API.atualizarCarroComImagem(id, formData);
                } else {
                    resultado = await API.criarCarroComImagem(formData);
                }

                if (resultado.sucesso) {
                    alert(id ? 'Carro atualizado com sucesso!' : 'Carro criado com sucesso!');
                    fecharModal('modal-carro');
                    carregarCarros();
                } else {
                    alert('Erro: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar carro:', error);
                alert('Erro ao salvar carro.');
            }
        });

        document.getElementById('form-acessorio').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('acessorio-id').value;
            const acessorio = {
                nome: document.getElementById('acessorio-nome').value,
                descricao: document.getElementById('acessorio-descricao').value,
                preco: parseFloat(document.getElementById('acessorio-preco').value)
            };

            try {
                let resultado;
                if (id) {
                    resultado = await API.atualizarAcessorio(id, acessorio);
                } else {
                    resultado = await API.criarAcessorio(acessorio);
                }

                if (resultado.sucesso) {
                    alert(id ? 'Acess√≥rio atualizado com sucesso!' : 'Acess√≥rio criado com sucesso!');
                    fecharModal('modal-acessorio');
                    carregarAcessorios();
                } else {
                    alert('Erro: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar acess√≥rio:', error);
                alert('Erro ao salvar acess√≥rio.');
            }
        });

        // Event listener para o formul√°rio de usu√°rio
        document.getElementById('form-usuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('usuario-id').value;
            const usuario = {
                nome: document.getElementById('usuario-nome').value,
                email: document.getElementById('usuario-email').value,
                tipo: document.getElementById('usuario-tipo').value
            };

            try {
                const resultado = await API.atualizarUsuario(id, usuario);

                if (resultado.sucesso) {
                    alert('Usu√°rio atualizado com sucesso!');
                    fecharModal('modal-usuario');
                    carregarUsuarios();
                    // Limpar resultado da busca se existir
                    document.getElementById('resultado-busca-usuarios').innerHTML = '';
                } else {
                    alert('Erro ao atualizar usu√°rio: ' + (resultado.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao atualizar usu√°rio:', error);
                alert('Erro ao atualizar usu√°rio.');
            }
        });

        // Fechar modal ao clicar fora dele
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
    <style>
        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</body>
</html>
